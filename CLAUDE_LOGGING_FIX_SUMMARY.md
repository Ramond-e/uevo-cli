# Claude æ—¥å¿—ç³»ç»Ÿä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜è¯Šæ–­

é€šè¿‡åˆ†ææ‚¨çš„æ—¥å¿—ï¼Œæˆ‘å‘ç°äº†å…³é”®é—®é¢˜ï¼š

### 1. å®é™…ä½¿ç”¨çš„æ˜¯ `streamMessage` è€Œä¸æ˜¯ `sendMessage`
**å‘ç°**ï¼šä»é”™è¯¯å †æ ˆå¯ä»¥çœ‹å‡ºè°ƒç”¨è·¯å¾„ï¼š
```
streamMessage.next (<anonymous>)
at GeminiClient.handleClaudeRequest
```

**é—®é¢˜**ï¼šæˆ‘ä¹‹å‰åªåœ¨ `sendMessage` æ–¹æ³•ä¸­æ·»åŠ äº† `logInteraction` è°ƒç”¨ï¼Œä½†å®é™…ä½¿ç”¨çš„æ˜¯ `streamMessage` æ–¹æ³•ï¼

### 2. ç¼–ç é—®é¢˜ä»ç„¶å­˜åœ¨
**ç°è±¡**ï¼šä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºä¸ºä¹±ç ï¼ˆ`éƒå •æ£¿` è€Œä¸æ˜¯ `æ—¶é—´`ï¼‰

### 3. é”™è¯¯ä¿¡æ¯ç°åœ¨æ­£ç¡®æ˜¾ç¤ºäº† âœ…
**æ”¹è¿›**ï¼šå¯ä»¥çœ‹åˆ°å®Œæ•´çš„é”™è¯¯å †æ ˆå’Œæ¶ˆæ¯

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåœ¨ `streamMessage` æ–¹æ³•ä¸­æ·»åŠ å®Œæ•´äº¤äº’æ—¥å¿—

**ä¿®æ”¹ä½ç½®**ï¼š`packages/core/src/core/anthropicClient.ts` çš„ `streamMessage` æ–¹æ³•

**å…³é”®ä¿®æ”¹**ï¼š
```typescript
// åœ¨æ¶ˆæ¯å¼€å§‹æ—¶æ„å»ºå“åº”å¯¹è±¡
case 'message_start':
  streamResponse = {
    id: event.message?.id || 'stream_msg',
    type: 'message', 
    role: 'assistant',
    content: [],
    usage: event.message?.usage || {}
  };

// åœ¨æ¶ˆæ¯ç»“æŸæ—¶è®°å½•å®Œæ•´äº¤äº’
case 'message_stop':
  // æ„å»ºå®Œæ•´çš„æµå¼å“åº”å¯¹è±¡
  if (streamResponse) {
    // æ·»åŠ æ–‡æœ¬å†…å®¹å’Œå·¥å…·è°ƒç”¨
    if (currentContent) {
      streamResponse.content.push({
        type: 'text',
        text: currentContent
      });
    }
    if (toolUses.length > 0) {
      streamResponse.content.push(...toolUses);
    }
    
    // è®°å½•å®Œæ•´çš„Claudeäº¤äº’ï¼ˆè¯·æ±‚+å“åº”ï¼‰
    ClaudeResponseLogger.logInteraction(requestParams, streamResponse, {
      userMessage: userMessage,
      model: model,
      conversationHistory: this.conversationHistory
    });
  }
```

### ä¿®å¤2ï¼šæ”¹è¿›æ–‡ä»¶ç¼–ç å¤„ç†

**ä¿®æ”¹**ï¼šä½¿ç”¨ `{ encoding: 'utf8' }` æ ¼å¼è€Œä¸æ˜¯ç®€å•çš„ `'utf8'` å­—ç¬¦ä¸²

## ğŸ¯ æœŸæœ›ç»“æœ

é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

### 1. å®Œæ•´äº¤äº’æ—¥å¿—æ–‡ä»¶ âœ¨
**æ–‡ä»¶å**ï¼š`claude-interaction-YYYY-MM-DDTHH-MM-SS-sssZ.txt`

**å†…å®¹ç¤ºä¾‹**ï¼š
```
================================================================================
æ—¶é—´: 2025/8/1 22:05:43
æ¨¡å‹: claude-3-5-sonnet-20241022
================================================================================

ç”¨æˆ·æ¶ˆæ¯:
ç°åœ¨å¯¹ä½ çš„shellå·¥å…·è¿›è¡Œæµ‹è¯•ï¼Œå°è¯•cdåˆ°packagesæ–‡ä»¶å¤¹

========================================
å‘é€ç»™Claudeçš„è¯·æ±‚:
========================================
{
  "model": "claude-3-5-sonnet-20241022",
  "max_tokens": 4096,
  "temperature": 0.1,
  "messages": [...],
  "tools": [
    {
      "name": "run_shell_command",
      "input_schema": {
        "type": "object",
        "properties": {
          "command": {
            "type": "string",
            "description": "Exact bash command to execute"
          }
        },
        "required": ["command"]  // â† å·¥å…·å®šä¹‰æ­£ç¡®
      }
    }
  ],
  "stream": true
}

========================================
Claudeçš„åŸå§‹å“åº”:
========================================
{
  "id": "msg_123456",
  "type": "message",
  "role": "assistant", 
  "content": [
    {
      "type": "text",
      "text": "æˆ‘æ¥å¸®ä½ æ‰§è¡Œ cd å‘½ä»¤..."
    },
    {
      "type": "tool_use",
      "id": "toolu_123",
      "name": "run_shell_command",
      "input": {}  // â† é—®é¢˜æ ¹æºï¼šClaudeå‘é€ç©ºå¯¹è±¡
    }
  ],
  "usage": {...}
}
```

### 2. å¢å¼ºçš„å·¥å…·è°ƒç”¨æ—¥å¿—
**æ”¹è¿›**ï¼š
- æ­£ç¡®çš„ä¸­æ–‡æ˜¾ç¤º
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ˆä¸å†æ˜¯ç©ºå¯¹è±¡ï¼‰
- Claudeå‘é€çš„åŸå§‹å·¥å…·è°ƒç”¨å¯¹è±¡

## ğŸ“‹ éªŒè¯æ­¥éª¤

1. **é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº**ï¼ˆé‡è¦ï¼ï¼‰
2. **å†æ¬¡æµ‹è¯•shellå·¥å…·**
3. **æ£€æŸ¥æ—¥å¿—ç›®å½•**ï¼š
   ```powershell
   Get-ChildItem "$env:USERPROFILE\claude-debug-logs" | Sort-Object LastWriteTime -Descending
   ```
4. **éªŒè¯æ–‡ä»¶ç±»å‹**ï¼š
   - âœ… `claude-interaction-*.txt` - å®Œæ•´äº¤äº’æ—¥å¿—
   - âœ… `claude-tool-*.txt` - å·¥å…·è°ƒç”¨æ—¥å¿—

## ğŸ” è°ƒè¯•ä»·å€¼

æœ‰äº†å®Œæ•´çš„äº¤äº’æ—¥å¿—ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

1. **çœ‹åˆ°å·¥å…·å®šä¹‰**ï¼šç¡®è®¤requiredå­—æ®µæ˜¯å¦æ­£ç¡®ä¼ é€’ç»™Claude
2. **åˆ†æClaudeå“åº”**ï¼šæ¸…æ¥šçœ‹åˆ°Claudeä¸ºä»€ä¹ˆå‘é€ç©ºçš„inputå¯¹è±¡
3. **æ£€æŸ¥ç³»ç»Ÿæç¤º**ï¼šæŸ¥çœ‹æ˜¯å¦éœ€è¦æ”¹è¿›æç¤ºè¯æ¥æŒ‡å¯¼Claudeæ­£ç¡®å¡«å……å‚æ•°
4. **è¿½è¸ªå®Œæ•´æµç¨‹**ï¼šä»ç”¨æˆ·æ¶ˆæ¯åˆ°APIè¯·æ±‚åˆ°Claudeå“åº”çš„å®Œæ•´è¿‡ç¨‹

## ğŸš€ ä¸‹ä¸€æ­¥

ä¸€æ—¦æ—¥å¿—ç³»ç»Ÿå®Œå…¨å·¥ä½œï¼Œæ‚¨å¯ä»¥ï¼š

1. **åˆ†æå·¥å…·å®šä¹‰é—®é¢˜**ï¼šæ£€æŸ¥schemaæ˜¯å¦æ­£ç¡®
2. **æ”¹è¿›ç³»ç»Ÿæç¤º**ï¼šæŒ‡å¯¼Claudeæ­£ç¡®ä½¿ç”¨å·¥å…·
3. **è¯Šæ–­å…¶ä»–å·¥å…·**ï¼šå°†æ­¤æ—¥å¿—ç³»ç»Ÿç”¨äºå…¶ä»–å·¥å…·çš„è°ƒè¯•

è¿™ä¸ªå®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿå°†æˆä¸ºæ‚¨è°ƒè¯•Claudeå·¥å…·è°ƒç”¨é—®é¢˜çš„å¼ºå¤§å·¥å…·ï¼